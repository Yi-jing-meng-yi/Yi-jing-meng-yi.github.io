<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>灵境工作室 Mystic Realm Studio</title>

  <!-- 强化 CSP: 禁止 eval/unsafe-inline 样式外部脚本只允许同源 (注意: GitHub Pages 需要在服务端 header 也设置，meta 方式有兼容限制) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'none'; object-src 'none'; base-uri 'self'; frame-ancestors 'none';">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* --- 基础重置 --- */
    html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family: "Microsoft YaHei","PingFang SC", "Noto Sans CJK SC",sans-serif;}
    :root{
      --w:100vw; --h:100vh;
    }

    /* 层叠画布容器（l1-l5 共存于同一页面，不随机弹出） */
    .scene {
      position:fixed; inset:0;
      display:block;
      overflow:hidden;
      background: linear-gradient(180deg,#a3d5ff,#cceeff); /* 默认 l1 */
      transition: background 1.2s ease;
    }

    /* 云的 canvas 全屏 */
    canvas#clouds {
      position:absolute; inset:0; width:100%; height:100%; pointer-events:none;
      filter: blur(0.6px);
    }

    /* l2 渐变叠层（在主界面可能被打开） */
    .layer-l2 {
      position:absolute; inset:0; pointer-events:none;
      background: linear-gradient(120deg, rgba(255,200,220,0.06), rgba(200,220,255,0.06));
      mix-blend-mode: screen;
      transition: opacity 1.2s ease;
    }

    /* l3 玫瑰金刻印纹理：用伪元素绘制重复纹理（纯 CSS） */
    .layer-l3 {
      position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(90deg, rgba(242,200,180,0.02), rgba(212,175,160,0.02));
      mix-blend-mode: overlay;
    }
    .layer-l3::after{
      content:"";
      position:absolute; inset:0;
      background-image:
        radial-gradient(circle at 10% 10%, rgba(255,235,230,0.03) 0 2px, transparent 2px),
        radial-gradient(circle at 30% 80%, rgba(255,240,238,0.02) 0 2px, transparent 2px);
      background-size: 40px 40px, 60px 60px;
      opacity:0.9;
      pointer-events:none;
    }

    /* l4 儒雅黑（深色系叠层）*/
    .layer-l4{ position:absolute; inset:0; background: rgba(16,16,16,0.4); mix-blend-mode:multiply; pointer-events:none; }

    /* l5 云白材质（近景高光云） */
    .layer-l5{ position:absolute; inset:0; pointer-events:none; }
    .layer-l5::before{
      content:""; position:absolute; inset:0;
      background: radial-gradient(ellipse at 70% 40%, rgba(255,255,255,0.06), transparent 10%),
                  radial-gradient(ellipse at 30% 70%, rgba(255,255,255,0.05), transparent 8%);
      pointer-events:none;
    }

    /* 中央标题区 */
    .center {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;
      z-index:40;
      user-select:none;
    }
    .title {
      font-size: clamp(32px,6vw,64px);
      line-height:1.02;
      font-weight:800;
      color:#fff;
      text-shadow: 0 6px 28px rgba(0,0,0,0.35), 0 0 12px rgba(255,255,255,0.06);
    }
    .subtitle {
      margin-top:12px; font-size:clamp(12px,1.6vw,18px); opacity:0.85;
      animation: blink 2200ms infinite;
      cursor:pointer;
    }
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}

    .intro { margin-top:18px; font-size: clamp(12px,1.6vw,18px); color:rgba(255,255,255,0.95) }

    /* 底部版权 */
    .footer {
      position:absolute; left:0; right:0; bottom:12px; display:flex; justify-content:space-between; align-items:center;
      padding: 0 18px; font-size:13px; color: rgba(255,255,255,0.8); z-index:45;
    }

    /* 锁定遮罩（检测到篡改时） */
    .tamper-lock {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:999;
      background: rgba(0,0,0,0.6); color:#fff; font-size:18px; text-align:center; padding:20px; box-sizing:border-box;
      display:none;
    }

    /* 人机验证弹窗基础 */
    .captcha-modal {
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:200; min-width:300px;
      background: linear-gradient(180deg,#ffffff10,#ffffff06); border-radius:12px; padding:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.5); color:#fff; display:none;
      backdrop-filter: blur(4px);
    }
    .captcha-modal button{ margin-top:12px; padding:8px 12px; border-radius:8px; cursor:pointer; }

    /* 响应式处理略写  */
  </style>
</head>
<body>
  <div class="scene" id="scene">
    <!-- canvas 用于画飘动云朵（l1 核心）-->
    <canvas id="clouds"></canvas>

    <!-- 其他叠层，默认隐藏/半透明，进入主界面后根据逻辑开启 -->
    <div class="layer-l2" id="layer-l2" style="opacity:0;"></div>
    <div class="layer-l3" id="layer-l3" style="opacity:0;"></div>
    <div class="layer-l4" id="layer-l4" style="opacity:0;"></div>
    <div class="layer-l5" id="layer-l5" style="opacity:0;"></div>

    <div class="center" id="center">
      <div class="title">灵境工作室<br><small style="font-weight:500;font-size:0.6em;opacity:0.9">Mystic Realm Studio</small></div>
      <div class="subtitle" id="enterBtn">点击进入主界面</div>
      <div class="intro">梦想成真是什么感觉? 做就知道了。</div>
    </div>

    <div class="footer">
      <div>怡境梦呓 ©</div>
      <div id="time">加载中...</div>
    </div>
  </div>

  <!-- 锁定遮罩（篡改检测） -->
  <div class="tamper-lock" id="tamperLock">检测到页面可能被修改或注入⚠️，已进入只读安全模式。如为误报，请刷新页面。</div>

  <!-- 人机验证弹窗（本地轻量版：算术题） -->
  <div class="captcha-modal" id="captchaModal">
    <div id="captchaContent">为继续，请完成下列验证：</div>
    <div style="margin-top:8px;">
      <label id="captchaQ"></label>
      <input id="captchaInput" type="text" style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid #ccc;">
    </div>
    <div style="text-align:right;">
      <button id="captchaSubmit">提交</button>
    </div>
    <div id="captchaMsg" style="margin-top:8px;color:#ffddaa"></div>
  </div>

  <!-- 受保护脚本：我们把关键脚本内容放到一个 <script type="application/json" id="protectedScript"> 中（仅用于示例完整性校验） -->
  <script type="application/json" id="protectedScript">
  {
    "note":"protected-block-v1",
    "purpose":"cloud-render + time + anti-tamper",
    "version":1,
    "payload":"use this field to store protected logic string—will be validated by SHA-256 at runtime"
  }
  </script>

  <!-- 主脚本（受保护内容校验 + 人机验证逻辑 + 云渲染） -->
  <script>
  (function(){
    'use strict';
    /* -------------------------
       配置区（可以修改）
       ------------------------- */
    const PROTECTED_ID = 'protectedScript';
    // 这里是 expectedHash：在构建时你可以把 protectedScript 内容算 SHA-256 并填入此处。
    // 下面是示例哈希（构建时请替换）。示例为 base64Url SHA-256。
    const expectedHash_b64url = 'REPLACE_WITH_REAL_HASH_AT_BUILD_TIME';

    // 服务器端接口（可选）：用于精确的 IP 计数。若没有可留空，客户端退回本地近似检测。
    const SERVER_CHECK_ENDPOINT = ''; // e.g. 'https://your-worker.example.com/api/check'
    const SERVER_REPORT_ENDPOINT = ''; // e.g. 'https://your-worker.example.com/api/report'

    /* -------------------------
       工具：base64url -> ArrayBuffer
       ------------------------- */
    function b64UrlToArrayBuffer(b64UrlString){
      // base64url -> base64
      let s = b64UrlString.replace(/-/g,'+').replace(/_/g,'/');
      while(s.length % 4) s += '=';
      const bin = atob(s);
      const len = bin.length;
      const arr = new Uint8Array(len);
      for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i);
      return arr.buffer;
    }

    async function computeSHA256ofString(str){
      const enc = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      // convert to base64url
      const b64 = arrayBufferToB64Url(hash);
      return b64;
    }
    function arrayBufferToB64Url(buf){
      const bytes = new Uint8Array(buf);
      let binary = '';
      for(let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]);
      const b64 = btoa(binary);
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    /* -------------------------
       防注入强化：覆盖敏感 setter，用于检测
       ------------------------- */
    (function installUnsafeWriteDetector(){
      try{
        const descriptor = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
        if(descriptor && descriptor.set){
          const originalSetter = descriptor.set;
          Object.defineProperty(Element.prototype, 'innerHTML', {
            configurable: true,
            get: descriptor.get,
            set: function(v){
              // 记录并调用原始 setter
              window.__detectedPotentialWrite = window.__detectedPotentialWrite || [];
              window.__detectedPotentialWrite.push({type:'innerHTML', node:this.tagName, time:Date.now()});
              originalSetter.call(this, v);
            }
          });
        }
      }catch(e){}
      // insertAdjacentHTML 监测
      try{
        const orig = Element.prototype.insertAdjacentHTML;
        Element.prototype.insertAdjacentHTML = function(pos, html){
          window.__detectedPotentialWrite = window.__detectedPotentialWrite || [];
          window.__detectedPotentialWrite.push({type:'insertAdjacentHTML', node:this.tagName, pos:pos, time:Date.now()});
          return orig.call(this,pos,html);
        };
      }catch(e){}
    })();

    /* -------------------------
       受保护脚本完整性校验
       ------------------------- */
    async function verifyProtectedBlock(){
      const el = document.getElementById(PROTECTED_ID);
      if(!el) return false;
      const txt = el.textContent || el.innerText || '';
      const h = await computeSHA256ofString(txt.trim());
      if(expectedHash_b64url === 'REPLACE_WITH_REAL_HASH_AT_BUILD_TIME'){
        // 开发提示：未替换哈希，跳过强校验，但仍做 DOM mutation 监控
        console.warn('[Integrity] expectedHash 未设置（请在构建时替换）');
        return true;
      }
      return h === expectedHash_b64url;
    }

    /* -------------------------
       DOM 关键区域监控（MutationObserver）
       ------------------------- */
    function installDomWatcher(){
      const lock = document.getElementById('tamperLock');
      const targets = [document.getElementById('center'), document.getElementById('clouds'), document.getElementById('time')];
      const config = { attributes:true, childList:true, subtree:true, characterData:true };
      const obs = new MutationObserver((mutations)=>{
        // 轻量统计：若发现对关键节点的新增 script/style 或大段文本被替换 就报警
        for(const m of mutations){
          if(m.type==='childList'){
            for(const n of m.addedNodes){
              if(n.nodeType===1 && (n.tagName==='SCRIPT' || n.tagName==='IFRAME' || n.tagName==='OBJECT')){
                // 关键注入：锁定
                lock.style.display='flex';
                console.error('[Tamper] 注入可疑节点', n);
                return;
              }
            }
          }
          if(m.type==='characterData' || m.type==='attributes'){
            // 记录并继续检查
            // 若多次触发则锁定（简单阈值）
            window.__tamperMutations = (window.__tamperMutations||0) + 1;
            if(window.__tamperMutations>6){
              lock.style.display='flex';
              console.error('[Tamper] 多次 DOM 变更，触发只读模式');
              return;
            }
          }
        }
      });
      for(const t of targets) if(t) obs.observe(t, config);
    }

    /* -------------------------
       云渲染：Canvas 绘制多层云（pure JS）
       ------------------------- */
    function startClouds(){
      const canvas = document.getElementById('clouds');
      const ctx = canvas.getContext('2d');
      const DPR = Math.max(1, window.devicePixelRatio || 1);
      function resize(){
        canvas.width = window.innerWidth * DPR;
        canvas.height = window.innerHeight * DPR;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resize, {passive:true});
      resize();

      // 生成云（对象池）
      const clouds = [];
      function mkCloud(i){
        return {
          x: -200 - Math.random()*400,
          y: Math.random() * window.innerHeight * 0.8,
          w: 120 + Math.random()*240,
          h: 60 + Math.random()*100,
          speed: 10 + Math.random()*35,
          alpha: 0.5 + Math.random()*0.5,
          swell: 0.5 + Math.random()*1.5
        };
      }
      for(let i=0;i<6;i++) clouds.push(mkCloud(i));

      let last = performance.now();
      function frame(now){
        const dt = Math.min(60,(now-last)/1000); last = now;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // 背景渐变（subtle）——保持 l1 基色
        const g = ctx.createLinearGradient(0,0,0,canvas.height/DPR);
        g.addColorStop(0,'#a3d5ff'); g.addColorStop(1,'#cceeff');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);

        // 绘制每朵云（简单模糊效果由 CSS filter 提供）
        for(const c of clouds){
          c.x += c.speed * dt;
          if(c.x - c.w > window.innerWidth + 100) {
            // recycle
            Object.assign(c, mkCloud());
            c.x = -c.w - Math.random()*200;
          }

          // 绘制云块
          ctx.save();
          ctx.globalAlpha = c.alpha * 0.9;
          const cx = c.x, cy = c.y, w = c.w, h = c.h;
          // 叠加几个椭圆
          ctx.beginPath();
          ctx.ellipse(cx + w*0.2, cy, w*0.6, h*0.6, 0, 0, Math.PI*2);
          ctx.ellipse(cx + w*0.5, cy - h*0.15, w*0.7, h*0.65, 0, 0, Math.PI*2);
          ctx.ellipse(cx + w*0.8, cy, w*0.5, h*0.55, 0, 0, Math.PI*2);
          ctx.closePath();
          // 渐变填充
          const gg = ctx.createLinearGradient(cx, cy-h, cx, cy+h);
          gg.addColorStop(0, 'rgba(255,255,255,0.95)');
          gg.addColorStop(1, 'rgba(240,245,255,0.85)');
          ctx.fillStyle = gg;
          ctx.fill();
          ctx.restore();
        }

        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    /* -------------------------
       时间更新（底部秒级时间）
       ------------------------- */
    function startClock(){
      const tEl = document.getElementById('time');
      function tick(){
        const now = new Date();
        const s = now.getFullYear() + '-' +
                  String(now.getMonth()+1).padStart(2,'0') + '-' +
                  String(now.getDate()).padStart(2,'0') + ' ' +
                  String(now.getHours()).padStart(2,'0') + ':' +
                  String(now.getMinutes()).padStart(2,'0') + ':' +
                  String(now.getSeconds()).padStart(2,'0');
        tEl.textContent = s;
      }
      tick();
      setInterval(tick,1000);
    }

    /* -------------------------
       本地(近似) 速率/重放 检测（2s 窗口内 10 次）——用于无服务器场景
       使用 localStorage + BroadcastChannel 进行跨标签同步
       ------------------------- */
    const LOCAL_KEY = '__mrs_access_times';
    function localRegisterAccessAndCheck(){
      try{
        const now = Date.now();
        let arr = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
        // 移除超过 2s 的旧数据
        arr = arr.filter(ts => now - ts <= 2000);
        arr.push(now);
        localStorage.setItem(LOCAL_KEY, JSON.stringify(arr));
        // 通知其他标签
        try{
          const bc = new BroadcastChannel('mrs_channel'); bc.postMessage({t:now}); bc.close();
        }catch(e){}
        return arr.length >= 10;
      }catch(e){
        return false;
      }
    }
    // 监听其他 tab 的通知以保持计数同步（降低误判）
    try{
      const bc = new BroadcastChannel('mrs_channel');
      bc.onmessage = (ev)=>{ /* 非必须：可以触发页面视觉反馈 */ };
    }catch(e){}

    /* -------------------------
       若有 SERVER_CHECK_ENDPOINT 则优先调用服务器端检测（更可靠）
       返回 { requireCaptcha: boolean }
       ------------------------- */
    async function serverCheck(){
      if(!SERVER_CHECK_ENDPOINT) return null;
      try{
        const r = await fetch(SERVER_CHECK_ENDPOINT, {method:'POST', credentials:'include'}); // include cookie 若需要
        if(!r.ok) return null;
        return await r.json();
      }catch(e){
        return null;
      }
    }

    /* -------------------------
       弹出本地轻量验证码 （算术）
       ------------------------- */
    function showLocalCaptcha(onSuccess){
      const modal = document.getElementById('captchaModal');
      const qEl = document.getElementById('captchaQ');
      const input = document.getElementById('captchaInput');
      const submit = document.getElementById('captchaSubmit');
      const msg = document.getElementById('captchaMsg');

      // 随机简单算术题
      const a = Math.floor(Math.random()*9)+1;
      const b = Math.floor(Math.random()*9)+1;
      const op = ['+','-'][Math.random()>0.5?0:1];
      const ans = op==='+'? a+b : a-b;
      qEl.textContent = `${a} ${op} ${b} = ?`;

      modal.style.display='block';
      input.value=''; msg.textContent='';

      function cleanup(){ modal.style.display='none'; submit.removeEventListener('click',onClick); }

      function onClick(){
        if(Number(input.value.trim())===ans){
          cleanup(); onSuccess && onSuccess(true);
        }else{
          msg.textContent = '答案错误，请重试';
        }
      }
      submit.addEventListener('click', onClick);
    }

    /* -------------------------
       初始化流程
       ------------------------- */
    async function init(){
      // 1) 校验受保护块完整性（若失败：进入锁定）
      const ok = await verifyProtectedBlock();
      if(!ok){
        document.getElementById('tamperLock').style.display='flex';
        return; // 不继续初始化
      }

      // 2) 启动观察器/云/时钟
      installDomWatcher();
      startClouds();
      startClock();

      // 3) 绑定进入主界面按钮：点击后（示例）逐步把 l2-l5 可视化（用户指定逻辑）
      document.getElementById('enterBtn').addEventListener('click', async ()=>{
        // 在进入主界面之前先做速率检测（优先服务器）
        let serverResp = null;
        if(SERVER_CHECK_ENDPOINT){
          serverResp = await serverCheck();
        }
        let requireCaptcha = false;
        if(serverResp && typeof serverResp.requireCaptcha !== 'undefined'){
          requireCaptcha = serverResp.requireCaptcha;
        }else{
          // 本地近似检测
          requireCaptcha = localRegisterAccessAndCheck();
        }

        if(requireCaptcha){
          // 触发本地人机验证（或如果你接了 reCAPTCHA，这里改为调出它）
          showLocalCaptcha(async (ok)=>{
            if(ok){
              // 报告一次成功解锁（可选）
              if(SERVER_REPORT_ENDPOINT){
                try{ await fetch(SERVER_REPORT_ENDPOINT, {method:'POST', body:JSON.stringify({event:'captcha_pass'}), headers:{'content-type':'application/json'}}); }catch(e){}
              }
              openMainInterface();
            }else{
              // remain locked
            }
          });
        }else{
          openMainInterface();
        }
      });
    }

    function openMainInterface(){
      // 进入主界面示例：渐入 l2~l5（你可以替换为菜单/动画）
      document.getElementById('layer-l2').style.opacity = 0.7;
      document.getElementById('layer-l3').style.opacity = 0.8;
      document.getElementById('layer-l4').style.opacity = 0.18;
      document.getElementById('layer-l5').style.opacity = 1.0;
      // 同时可以将提示改成返回或导航
      document.getElementById('enterBtn').textContent = '已进入主界面';
    }

    // 启动
    init().catch(e=>{ console.error('初始化失败',e); });

  })();
  </script>
</body>
</html>
